<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>OpenServo RS485: Dokumentacja pliku pwm.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">OpenServo RS485
   &#160;<span id="projectnumber">1.0</span>
   </div>
   <div id="projectbrief">OpenServo z komunikacją z użyciem interfejsu RS485</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Wygenerowano przez Doxygen 1.8.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Strona&#160;główna</span></a></li>
      <li><a href="modules.html"><span>Moduły</span></a></li>
      <li><a href="annotated.html"><span>Struktury&#160;Danych</span></a></li>
      <li class="current"><a href="files.html"><span>Pliki</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>Lista&#160;plików</span></a></li>
      <li><a href="globals.html"><span>Globalne</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('pwm_8c.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="summary">
<a href="#define-members">Definicje</a> &#124;
<a href="#func-members">Funkcje</a>  </div>
  <div class="headertitle">
<div class="title">Dokumentacja pliku pwm.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &lt;inttypes.h&gt;</code><br/>
<code>#include &lt;avr/interrupt.h&gt;</code><br/>
<code>#include &lt;avr/io.h&gt;</code><br/>
<code>#include &quot;<a class="el" href="openservo_8h_source.html">openservo.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="config_8h_source.html">config.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="pwm_8h_source.html">pwm.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="registers_8h_source.html">registers.h</a>&quot;</code><br/>
</div>
<p><a href="pwm_8c_source.html">Idź do kodu źródłowego tego pliku.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2><a name="define-members"></a>
Definicje</h2></td></tr>
<tr class="memitem:ab846e1376cee122c2d77efe3a6a41b38"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pwm_8c.html#ab846e1376cee122c2d77efe3a6a41b38">PWM_TOP_VALUE</a>(div)&#160;&#160;&#160;((uint16_t) div &lt;&lt; 4) - 1;</td></tr>
<tr class="memitem:afadd40311ede9239cc5a810f18460a91"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pwm_8c.html#afadd40311ede9239cc5a810f18460a91">PWM_OCRN_VALUE</a>(div, pwm)&#160;&#160;&#160;(uint16_t) (((uint32_t) pwm * (((uint32_t) div &lt;&lt; 4) - 1)) / 255)</td></tr>
<tr class="memitem:acec2b00b2b399352efcf572e9dab9413"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pwm_8c.html#acec2b00b2b399352efcf572e9dab9413">DELAYLOOP</a>&#160;&#160;&#160;8</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2><a name="func-members"></a>
Funkcje</h2></td></tr>
<tr class="memitem:ad3a1781dd92142e14d906adddfe3959d"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pwm_8c.html#ad3a1781dd92142e14d906adddfe3959d">pwm_registers_defaults</a> (void)</td></tr>
<tr class="memitem:a1e8fdae3fd7118582ffa427dad05b6e1"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pwm_8c.html#a1e8fdae3fd7118582ffa427dad05b6e1">pwm_init</a> (void)</td></tr>
<tr class="memitem:a838091d10e0130765f95953a5199a4d0"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pwm_8c.html#a838091d10e0130765f95953a5199a4d0">pwm_update</a> (uint16_t position, int16_t pwm)</td></tr>
<tr class="memitem:aec8f4f09d7d0222e947bea4b37fc33c2"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pwm_8c.html#aec8f4f09d7d0222e947bea4b37fc33c2">pwm_stop</a> (void)</td></tr>
</table>
<hr/><h2>Dokumentacja definicji</h2>
<a class="anchor" id="acec2b00b2b399352efcf572e9dab9413"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define DELAYLOOP&#160;&#160;&#160;8</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definicja w linii <a class="el" href="pwm_8c_source.html#l00078">78</a> pliku <a class="el" href="pwm_8c_source.html">pwm.c</a>.</p>

<p>Odwołania w <a class="el" href="pwm_8c_source.html#l00373">pwm_stop()</a> i <a class="el" href="pwm_8c_source.html#l00252">pwm_update()</a>.</p>

</div>
</div>
<a class="anchor" id="afadd40311ede9239cc5a810f18460a91"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define PWM_OCRN_VALUE</td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">div, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">pwm&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td>&#160;&#160;&#160;(uint16_t) (((uint32_t) pwm * (((uint32_t) div &lt;&lt; 4) - 1)) / 255)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definicja w linii <a class="el" href="pwm_8c_source.html#l00062">62</a> pliku <a class="el" href="pwm_8c_source.html">pwm.c</a>.</p>

</div>
</div>
<a class="anchor" id="ab846e1376cee122c2d77efe3a6a41b38"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define PWM_TOP_VALUE</td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">div</td><td>)</td>
          <td>&#160;&#160;&#160;((uint16_t) div &lt;&lt; 4) - 1;</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definicja w linii <a class="el" href="pwm_8c_source.html#l00059">59</a> pliku <a class="el" href="pwm_8c_source.html">pwm.c</a>.</p>

<p>Odwołania w <a class="el" href="pwm_8c_source.html#l00207">pwm_init()</a> i <a class="el" href="pwm_8c_source.html#l00252">pwm_update()</a>.</p>

</div>
</div>
<hr/><h2>Dokumentacja funkcji</h2>
<a class="anchor" id="a1e8fdae3fd7118582ffa427dad05b6e1"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void pwm_init </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definicja w linii <a class="el" href="pwm_8c_source.html#l00207">207</a> pliku <a class="el" href="pwm_8c_source.html">pwm.c</a>.</p>

<p>Odwołuje się do <a class="el" href="pwm_8c_source.html#l00059">PWM_TOP_VALUE</a>, <a class="el" href="registers_8h_source.html#l00052">REG_PWM_DIRA</a>, <a class="el" href="registers_8h_source.html#l00053">REG_PWM_DIRB</a>, <a class="el" href="registers_8h_source.html#l00088">REG_PWM_FREQ_DIVIDER_HI</a>, <a class="el" href="registers_8h_source.html#l00089">REG_PWM_FREQ_DIVIDER_LO</a> i <a class="el" href="registers_8c_source.html#l00104">registers_read_word()</a>.</p>

<p>Odwołania w <a class="el" href="main_8c_source.html#l00104">main()</a>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">    <span class="comment">// Initialize the pwm frequency divider value.</span></div>
<div class="line">    pwm_div = <a class="code" href="registers_8c.html#af8b091233149e27ba0ce0995fee7756b">registers_read_word</a>(<a class="code" href="registers_8h.html#ab075f005f7a933e8ad3623fdf452c9af">REG_PWM_FREQ_DIVIDER_HI</a>, <a class="code" href="registers_8h.html#a72bc114d1422c39404c72ff191d572da">REG_PWM_FREQ_DIVIDER_LO</a>);</div>
<div class="line"></div>
<div class="line">    TCCR1A = 0;</div>
<div class="line">        __asm__(<span class="stringliteral">&quot;nop&quot;</span>);</div>
<div class="line">        __asm__(<span class="stringliteral">&quot;nop&quot;</span>);</div>
<div class="line">        __asm__(<span class="stringliteral">&quot;nop&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Set PB1/OC1A and PB2/OC1B to low.</span></div>
<div class="line">    PORTB &amp;= ~((1&lt;&lt;PB1) | (1&lt;&lt;PB2));</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Enable PB1/OC1A and PB2/OC1B as outputs.</span></div>
<div class="line">    DDRB |= ((1&lt;&lt;DDB1) | (1&lt;&lt;DDB2));</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Reset the timer1 configuration.</span></div>
<div class="line">    TCNT1 = 0;</div>
<div class="line">    TCCR1A = 0;</div>
<div class="line">    TCCR1B = 0;</div>
<div class="line">    TCCR1C = 0;</div>
<div class="line">    TIMSK1 = 0;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Set timer top value.</span></div>
<div class="line">    ICR1 = <a class="code" href="pwm_8c.html#ab846e1376cee122c2d77efe3a6a41b38">PWM_TOP_VALUE</a>(pwm_div);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Set the PWM duty cycle to zero.</span></div>
<div class="line">    OCR1A = 0;</div>
<div class="line">    OCR1B = 0;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Configure timer 1 for PWM, Phase and Frequency Correct operation, but leave outputs disabled.</span></div>
<div class="line">    TCCR1A = (0&lt;&lt;COM1A1) | (0&lt;&lt;COM1A0) |                    <span class="comment">// Disable OC1A output.</span></div>
<div class="line">             (0&lt;&lt;COM1B1) | (0&lt;&lt;COM1B0) |                    <span class="comment">// Disable OC1B output.</span></div>
<div class="line">             (0&lt;&lt;WGM11) | (0&lt;&lt;WGM10);                       <span class="comment">// PWM, Phase and Frequency Correct, TOP = ICR1</span></div>
<div class="line">    TCCR1B = (0&lt;&lt;ICNC1) | (0&lt;&lt;ICES1) |                      <span class="comment">// Input on ICP1 disabled.</span></div>
<div class="line">             (1&lt;&lt;WGM13) | (0&lt;&lt;WGM12) |                      <span class="comment">// PWM, Phase and Frequency Correct, TOP = ICR1</span></div>
<div class="line">             (0&lt;&lt;CS12) | (0&lt;&lt;CS11) | (1&lt;&lt;CS10);             <span class="comment">// No prescaling.</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">// Update the pwm values.</span></div>
<div class="line">    registers_write_byte(<a class="code" href="registers_8h.html#ae61da0c85e2949c372b286d10a870174">REG_PWM_DIRA</a>, 0);</div>
<div class="line">    registers_write_byte(<a class="code" href="registers_8h.html#add869b129d1d025bb82d444c821c83e9">REG_PWM_DIRB</a>, 0);</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="ad3a1781dd92142e14d906adddfe3959d"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void pwm_registers_defaults </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definicja w linii <a class="el" href="pwm_8c_source.html#l00193">193</a> pliku <a class="el" href="pwm_8c_source.html">pwm.c</a>.</p>

<p>Odwołuje się do <a class="el" href="config_8h_source.html#l00189">DEFAULT_PWM_FREQ_DIVIDER</a>, <a class="el" href="registers_8h_source.html#l00088">REG_PWM_FREQ_DIVIDER_HI</a>, <a class="el" href="registers_8h_source.html#l00089">REG_PWM_FREQ_DIVIDER_LO</a> i <a class="el" href="registers_8c_source.html#l00125">registers_write_word()</a>.</p>

<p>Odwołania w <a class="el" href="registers_8c_source.html#l00069">registers_defaults()</a>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">    <span class="comment">// PWM divider is a value between 1 and 1024.  This divides the fundamental</span></div>
<div class="line">    <span class="comment">// PWM frequency (500 kHz for 8MHz clock, 1250 kHz for 20MHz clock) by a</span></div>
<div class="line">    <span class="comment">// constant value to produce a PWM frequency suitable to drive a motor.  A</span></div>
<div class="line">    <span class="comment">// small motor with low inductance and impedance such as those found in an</span></div>
<div class="line">    <span class="comment">// RC servo will my typically use a divider value between 16 and 64.  A larger</span></div>
<div class="line">    <span class="comment">// motor with higher inductance and impedance may require a greater divider.</span></div>
<div class="line">    <a class="code" href="registers_8c.html#a2a7b20190fe395643f0d180422422e78">registers_write_word</a>(<a class="code" href="registers_8h.html#ab075f005f7a933e8ad3623fdf452c9af">REG_PWM_FREQ_DIVIDER_HI</a>, <a class="code" href="registers_8h.html#a72bc114d1422c39404c72ff191d572da">REG_PWM_FREQ_DIVIDER_LO</a>, <a class="code" href="config_8h.html#a6f4dc07662b1e0c01ddd085786cdce89">DEFAULT_PWM_FREQ_DIVIDER</a>);</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="aec8f4f09d7d0222e947bea4b37fc33c2"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void pwm_stop </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definicja w linii <a class="el" href="pwm_8c_source.html#l00373">373</a> pliku <a class="el" href="pwm_8c_source.html">pwm.c</a>.</p>

<p>Odwołuje się do <a class="el" href="pwm_8c_source.html#l00078">DELAYLOOP</a>, <a class="el" href="registers_8h_source.html#l00052">REG_PWM_DIRA</a> i <a class="el" href="registers_8h_source.html#l00053">REG_PWM_DIRB</a>.</p>

<p>Odwołania w <a class="el" href="pwm_8c_source.html#l00252">pwm_update()</a>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">    <span class="comment">// Disable interrupts.</span></div>
<div class="line">    cli();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Are we moving in the A or B direction?</span></div>
<div class="line">    <span class="keywordflow">if</span> (pwm_a || pwm_b)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// Disable OC1A and OC1B outputs.</span></div>
<div class="line">        TCCR1A &amp;= ~((1&lt;&lt;COM1A1) | (1&lt;&lt;COM1A0));</div>
<div class="line">        TCCR1A &amp;= ~((1&lt;&lt;COM1B1) | (1&lt;&lt;COM1B0));</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Clear PB1 and PB2.</span></div>
<div class="line">        PORTB &amp;= ~((1&lt;&lt;PB1) | (1&lt;&lt;PB2));</div>
<div class="line"></div>
<div class="line">        delay_loop(<a class="code" href="pwm_8c.html#acec2b00b2b399352efcf572e9dab9413">DELAYLOOP</a>);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Reset the A and B direction flags.</span></div>
<div class="line">        pwm_a = 0;</div>
<div class="line">        pwm_b = 0;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Set the PWM duty cycle to zero.</span></div>
<div class="line">    OCR1A = 0;</div>
<div class="line">    OCR1B = 0;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Restore interrupts.</span></div>
<div class="line">    sei();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Save the pwm A and B duty values.</span></div>
<div class="line">    registers_write_byte(<a class="code" href="registers_8h.html#ae61da0c85e2949c372b286d10a870174">REG_PWM_DIRA</a>, pwm_a);</div>
<div class="line">    registers_write_byte(<a class="code" href="registers_8h.html#add869b129d1d025bb82d444c821c83e9">REG_PWM_DIRB</a>, pwm_b);</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a838091d10e0130765f95953a5199a4d0"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void pwm_update </td>
          <td>(</td>
          <td class="paramtype">uint16_t&#160;</td>
          <td class="paramname"><em>position</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int16_t&#160;</td>
          <td class="paramname"><em>pwm</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definicja w linii <a class="el" href="pwm_8c_source.html#l00252">252</a> pliku <a class="el" href="pwm_8c_source.html">pwm.c</a>.</p>

<p>Odwołuje się do <a class="el" href="pwm_8c_source.html#l00078">DELAYLOOP</a>, <a class="el" href="registers_8h_source.html#l00181">FLAGS_LO_PWM_ENABLED</a>, <a class="el" href="pwm_8c_source.html#l00373">pwm_stop()</a>, <a class="el" href="pwm_8c_source.html#l00059">PWM_TOP_VALUE</a>, <a class="el" href="registers_8h_source.html#l00042">REG_FLAGS_LO</a>, <a class="el" href="registers_8h_source.html#l00092">REG_MAX_SEEK_HI</a>, <a class="el" href="registers_8h_source.html#l00093">REG_MAX_SEEK_LO</a>, <a class="el" href="registers_8h_source.html#l00090">REG_MIN_SEEK_HI</a>, <a class="el" href="registers_8h_source.html#l00091">REG_MIN_SEEK_LO</a>, <a class="el" href="registers_8h_source.html#l00088">REG_PWM_FREQ_DIVIDER_HI</a>, <a class="el" href="registers_8h_source.html#l00089">REG_PWM_FREQ_DIVIDER_LO</a>, <a class="el" href="registers_8h_source.html#l00094">REG_REVERSE_SEEK</a> i <a class="el" href="registers_8c_source.html#l00104">registers_read_word()</a>.</p>

<p>Odwołania w <a class="el" href="main_8c_source.html#l00104">main()</a>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">    uint8_t pwm_width;</div>
<div class="line">    uint16_t min_position;</div>
<div class="line">    uint16_t max_position;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Quick check to see if the frequency divider changed.  If so we need to</span></div>
<div class="line">    <span class="comment">// configure a new top value for timer/counter1.  This value should only</span></div>
<div class="line">    <span class="comment">// change infrequently so we aren&#39;t too elegant in how we handle updating</span></div>
<div class="line">    <span class="comment">// the value.  However, we need to be careful that we don&#39;t configure the</span></div>
<div class="line">    <span class="comment">// top to a value lower than the counter and compare values.</span></div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="registers_8c.html#af8b091233149e27ba0ce0995fee7756b">registers_read_word</a>(<a class="code" href="registers_8h.html#ab075f005f7a933e8ad3623fdf452c9af">REG_PWM_FREQ_DIVIDER_HI</a>, <a class="code" href="registers_8h.html#a72bc114d1422c39404c72ff191d572da">REG_PWM_FREQ_DIVIDER_LO</a>) != pwm_div)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// Disable OC1A and OC1B outputs.</span></div>
<div class="line">        TCCR1A &amp;= ~((1&lt;&lt;COM1A1) | (1&lt;&lt;COM1A0));</div>
<div class="line">        TCCR1A &amp;= ~((1&lt;&lt;COM1B1) | (1&lt;&lt;COM1B0));</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Clear PB1 and PB2.</span></div>
<div class="line">        PORTB &amp;= ~((1&lt;&lt;PB1) | (1&lt;&lt;PB2));</div>
<div class="line"></div>
<div class="line">        delay_loop(<a class="code" href="pwm_8c.html#acec2b00b2b399352efcf572e9dab9413">DELAYLOOP</a>);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Reset the A and B direction flags.</span></div>
<div class="line">        pwm_a = 0;</div>
<div class="line">        pwm_b = 0;</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Update the pwm frequency divider value.</span></div>
<div class="line">        pwm_div = <a class="code" href="registers_8c.html#af8b091233149e27ba0ce0995fee7756b">registers_read_word</a>(<a class="code" href="registers_8h.html#ab075f005f7a933e8ad3623fdf452c9af">REG_PWM_FREQ_DIVIDER_HI</a>, <a class="code" href="registers_8h.html#a72bc114d1422c39404c72ff191d572da">REG_PWM_FREQ_DIVIDER_LO</a>);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Update the timer top value.</span></div>
<div class="line">        ICR1 = <a class="code" href="pwm_8c.html#ab846e1376cee122c2d77efe3a6a41b38">PWM_TOP_VALUE</a>(pwm_div);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Reset the counter and compare values to prevent problems with the new top value.</span></div>
<div class="line">        TCNT1 = 0;</div>
<div class="line">        OCR1A = 0;</div>
<div class="line">        OCR1B = 0;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Are we reversing the seek sense?</span></div>
<div class="line">    <span class="keywordflow">if</span> (registers_read_byte(<a class="code" href="registers_8h.html#a512d65e283c5e4481353eba8a226fd76">REG_REVERSE_SEEK</a>) != 0)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// Yes. Swap the minimum and maximum position.</span></div>
<div class="line"></div>
<div class="line">        <span class="comment">// Get the minimum and maximum seek position.</span></div>
<div class="line">        min_position = <a class="code" href="registers_8c.html#af8b091233149e27ba0ce0995fee7756b">registers_read_word</a>(<a class="code" href="registers_8h.html#ad33d318398d6d9212ffda3302e333667">REG_MAX_SEEK_HI</a>, <a class="code" href="registers_8h.html#a9c22bbf6c47239cf536841620f947cc8">REG_MAX_SEEK_LO</a>);</div>
<div class="line">        max_position = <a class="code" href="registers_8c.html#af8b091233149e27ba0ce0995fee7756b">registers_read_word</a>(<a class="code" href="registers_8h.html#a4057f850fd9b0870d1d25f047fa47147">REG_MIN_SEEK_HI</a>, <a class="code" href="registers_8h.html#af895680d43595c4971277de44651f0cd">REG_MIN_SEEK_LO</a>);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Make sure these values are sane 10-bit values.</span></div>
<div class="line">        <span class="keywordflow">if</span> (min_position &gt; 0x3ff) min_position = 0x3ff;</div>
<div class="line">        <span class="keywordflow">if</span> (max_position &gt; 0x3ff) max_position = 0x3ff;</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Adjust the values because of the reverse sense.</span></div>
<div class="line">        min_position = 0x3ff - min_position;</div>
<div class="line">        max_position = 0x3ff - max_position;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// No. Use the minimum and maximum position as is.</span></div>
<div class="line"></div>
<div class="line">        <span class="comment">// Get the minimum and maximum seek position.</span></div>
<div class="line">        min_position = <a class="code" href="registers_8c.html#af8b091233149e27ba0ce0995fee7756b">registers_read_word</a>(<a class="code" href="registers_8h.html#a4057f850fd9b0870d1d25f047fa47147">REG_MIN_SEEK_HI</a>, <a class="code" href="registers_8h.html#af895680d43595c4971277de44651f0cd">REG_MIN_SEEK_LO</a>);</div>
<div class="line">        max_position = <a class="code" href="registers_8c.html#af8b091233149e27ba0ce0995fee7756b">registers_read_word</a>(<a class="code" href="registers_8h.html#ad33d318398d6d9212ffda3302e333667">REG_MAX_SEEK_HI</a>, <a class="code" href="registers_8h.html#a9c22bbf6c47239cf536841620f947cc8">REG_MAX_SEEK_LO</a>);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Make sure these values are sane 10-bit values.</span></div>
<div class="line">        <span class="keywordflow">if</span> (min_position &gt; 0x3ff) min_position = 0x3ff;</div>
<div class="line">        <span class="keywordflow">if</span> (max_position &gt; 0x3ff) max_position = 0x3ff;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Disable clockwise movements when position is below the minimum position.</span></div>
<div class="line">    <span class="keywordflow">if</span> ((position &lt; min_position) &amp;&amp; (pwm &lt; 0)) pwm = 0;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Disable counter-clockwise movements when position is above the maximum position.</span></div>
<div class="line">    <span class="keywordflow">if</span> ((position &gt; max_position) &amp;&amp; (pwm &gt; 0)) pwm = 0;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Determine if PWM is disabled in the registers.</span></div>
<div class="line">    <span class="keywordflow">if</span> (!(registers_read_byte(<a class="code" href="registers_8h.html#a196ff8b454bb2a2cf5777814aedaba5e">REG_FLAGS_LO</a>) &amp; (1&lt;&lt;<a class="code" href="registers_8h.html#aa1158632d7f0ea4ad0f6a2e4e5253f71">FLAGS_LO_PWM_ENABLED</a>))) pwm = 0;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Determine direction of servo movement or stop.</span></div>
<div class="line">    <span class="keywordflow">if</span> (pwm &lt; 0)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// Less than zero. Turn clockwise.</span></div>
<div class="line"></div>
<div class="line">        <span class="comment">// Get the PWM width from the PWM value.</span></div>
<div class="line">        pwm_width = (uint8_t) -pwm;</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Turn clockwise.</span></div>
<div class="line"><span class="preprocessor">#if SWAP_PWM_DIRECTION_ENABLED</span></div>
<div class="line"><span class="preprocessor"></span>        pwm_dir_a(pwm_width);</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>        pwm_dir_b(pwm_width);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pwm &gt; 0)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// More than zero. Turn counter-clockwise.</span></div>
<div class="line"></div>
<div class="line">        <span class="comment">// Get the PWM width from the PWM value.</span></div>
<div class="line">        pwm_width = (uint8_t) pwm;</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Turn counter-clockwise.</span></div>
<div class="line"><span class="preprocessor">#if SWAP_PWM_DIRECTION_ENABLED</span></div>
<div class="line"><span class="preprocessor"></span>        pwm_dir_b(pwm_width);</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>        pwm_dir_a(pwm_width);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// Stop all PWM activity to the motor.</span></div>
<div class="line">        <a class="code" href="pwm_8c.html#aec8f4f09d7d0222e947bea4b37fc33c2">pwm_stop</a>();</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="pwm_8c.html">pwm.c</a></li>
    <li class="footer">Wygenerowano Cz, 31 maj 2012 10:58:50 dla OpenServo RS485 programem
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.1 </li>
  </ul>
</div>
</body>
</html>
